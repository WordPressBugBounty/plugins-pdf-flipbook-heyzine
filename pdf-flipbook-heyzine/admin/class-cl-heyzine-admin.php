<?php
/**
 * The admin-specific functionality of the plugin.
 *
 * @link       https://heyzine.com/
 * @since      1.0.0
 *
 * @package    Cl_Heyzine
 * @subpackage Cl_Heyzine/admin
 */

/**
 * The admin-specific functionality of the plugin.
 *
 * Defines the plugin name, version, and two examples hooks for how to
 * enqueue the admin-specific stylesheet and JavaScript.
 *
 * @package    Cl_Heyzine
 * @subpackage Cl_Heyzine/admin
 */
class Cl_Heyzine_Admin {

	/**
	 * The ID of this plugin.
	 *
	 * @since    1.0.0
	 * @access   private
	 * @var      string    $plugin_name    The ID of this plugin.
	 */
	private $plugin_name;

	/**
	 * The version of this plugin.
	 *
	 * @since    1.0.0
	 * @access   private
	 * @var      string    $version    The current version of this plugin.
	 */
	private $version;

	/**
	 * Heyzine API base URL.
	 *
	 * @var string $base_url Heyzine API base URL.
	 */
	private $base_url = 'https://heyzine.com';

	/**
	 * Heyzine API authorize endpoint.
	 *
	 * @var string $api_auth Heyzine API authorize endpoint.
	 */
	private $api_auth = '/api2/authorize';

	/**
	 * Heyzine API token endpoint.
	 *
	 * @var string $api_token Heyzine API token endpoint.
	 */
	private $api_token = '/api2/token';

	/**
	 * Heyzine API flipbook list endpoint.
	 *
	 * @var string $api_flipbook_list Heyzine API flipbook list endpoint.
	 */
	private $api_flipbook_list = '/api2/list';

	/**
	 * Heyzine API flipbook endpoint.
	 *
	 * @var string $api_flipbook Heyzine API flipbook endpoint.
	 */
	private $api_flipbook = '/api2/flipbook';

	/**
	 * Heyzine API flipbook state endpoint.
	 *
	 * @var string $api_flipbook_state Heyzine API flipbook state endpoint.
	 */
	private $api_flipbook_state = '/api2/flipbook-state';	

	/**
	 * Heyzine API flipbook save settings endpoint.
	 *
	 * @var string $api_flipbook_settings Heyzine API flipbook save settings endpoint.
	 */
	private $api_flipbook_settings = '/api2/flipbook-settings';		

	/**
	 * Heyzine API new flipbook endpoint.
	 *
	 * @var string $api_new_flipbook Heyzine API new flipbook endpoint.
	 */
	private $api_new_flipbook = '/api2/create';

	/**
	 * Heyzine API current user connected endpoint.
	 *
	 * @var string $api_me Heyzine API current user connected endpoint.
	 */
	private $api_me = '/api2/me';	

	/**
	 * Heyzine API client ID.
	 *
	 * @var string $client_id Heyzine API client ID.
	 */
	private $client_id = 'heyzine_wordpress';

	/**
	 * Heyzine API client secret.
	 *
	 * @var string $client_secret Heyzine API client secret.
	 */
	private $client_secret = 'dvXmtX3eLCyKU3z1VyH3';

	/**
	 * Heyzine API redirect URI.
	 *
	 * @var string $redirect_uri Heyzine API redirect URI.
	 */
	private $redirect_uri = '';

	/**
	 * Heyzine nonce action.
	 *
	 * @var string $nonce_action Heyzine nonce action.
	 */
	private $nonce_action = 'heyzine_nonce_action_state';

	/**
	 * Heyzine namespace.
	 *
	 * @var string $heyzine_namespace Heyzine namespace.
	 */
	private $heyzine_namespace = 'heyzine/v1';


	/**
	 * Initialize the class and set its properties.
	 *
	 * @since    1.0.0
	 * @param    string $plugin_name  The name of this plugin.
	 * @param    string $version      The version of this plugin.
	 */
	public function __construct( $plugin_name, $version ) {
		$this->plugin_name  = $plugin_name;
		$this->version      = $version;
		$this->redirect_uri = admin_url( 'admin.php?page=heyzine' );
	}

	/**
	 * Register the inline JavaScript for the admin area.
	 *
	 * @since    1.0.0
	 */
	public function inline_scripts() {
		global $pagenow;
		if ( 'admin.php' === $pagenow && isset( $_GET['page'] ) && 'heyzine' === $_GET['page'] ) { // phpcs:ignore
			$params        = array(
				'title'      => __( 'Select a file to create a new heyzine flipbook', 'pdf-flipbook-heyzine' ),
				'btn'        => __( 'Select file', 'pdf-flipbook-heyzine' ),
				'page'       => __( 'Page', 'pdf-flipbook-heyzine' ),
				'api_url'    => esc_url_raw(rest_url($this->heyzine_namespace)),
				'nonce'  => wp_create_nonce('wp_rest')
			);
			$localize_vars = 'const CL_HEYZINE = ' . wp_json_encode( $params ) . ';';

			$script = $localize_vars . file_get_contents( CL_HEYZINE_PLUGIN_PATH . 'admin/js/cl-heyzine-admin-inline.js' ); // phpcs:ignore

			wp_enqueue_media();
			wp_register_script( 'cl-heyzine-upload-new', '', array(), CL_HEYZINE_VERSION, true );
			wp_enqueue_script( 'cl-heyzine-upload-new' );
			wp_add_inline_script( 'cl-heyzine-upload-new', $script );
		}
	}

	/**
	 * Register the inline CSS for the admin area.
	 *
	 * @since    1.0.0
	 */
	public function inline_css() {
		global $pagenow;
		if ( 'admin.php' === $pagenow && isset( $_GET['page'] ) && 'heyzine' === $_GET['page'] ) { // phpcs:ignore
			$css = file_get_contents( CL_HEYZINE_PLUGIN_PATH . 'admin/css/cl-heyzine-admin-inline.css' ); // phpcs:ignore

			wp_register_style( 'cl-heyzine', '', array(), CL_HEYZINE_VERSION );
			wp_enqueue_style( 'cl-heyzine' );
			wp_add_inline_style( 'cl-heyzine', $css );
		}
	}

	/**
	 * Register the menu for this plugin into the WordPress Dashboard menu.
	 */
	public function admin_menu() {
		$svg_heyzine = '<svg id="svg" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="400" height="400" viewBox="0, 0, 400,400"><g id="svgg"><path id="path1" d="M69.500 0.296 C 67.824 0.401,67.200 0.597,67.200 1.020 C 67.200 1.339,67.065 1.579,66.900 1.553 C 65.333 1.305,63.200 1.678,63.200 2.200 C 63.200 2.643,62.736 2.800,61.424 2.800 C 60.447 2.800,59.536 2.980,59.400 3.200 C 59.264 3.420,58.539 3.600,57.789 3.600 C 56.741 3.600,56.478 3.739,56.655 4.200 C 56.821 4.633,56.595 4.814,55.843 4.850 C 54.310 4.923,54.097 4.970,53.767 5.300 C 53.602 5.465,52.861 5.600,52.121 5.600 C 51.293 5.600,50.686 5.831,50.545 6.200 C 50.418 6.530,49.963 6.800,49.534 6.800 C 49.104 6.800,48.852 6.961,48.974 7.158 C 49.227 7.567,48.299 8.000,47.167 8.000 C 46.745 8.000,46.400 8.180,46.400 8.400 C 46.400 8.620,45.950 8.800,45.400 8.800 C 44.778 8.800,44.400 9.027,44.400 9.400 C 44.400 9.730,44.130 10.000,43.800 10.000 C 43.470 10.000,43.200 10.180,43.200 10.400 C 43.200 10.620,42.750 10.800,42.200 10.800 C 41.650 10.800,41.245 11.009,41.300 11.265 C 41.355 11.520,40.950 11.851,40.400 12.000 C 39.850 12.149,39.445 12.480,39.500 12.735 C 39.555 12.991,39.240 13.200,38.800 13.200 C 38.360 13.200,38.000 13.380,38.000 13.600 C 38.000 13.820,37.719 14.000,37.376 14.000 C 37.033 14.000,36.863 14.178,36.997 14.395 C 37.137 14.622,36.977 14.689,36.621 14.553 C 36.279 14.422,36.000 14.514,36.000 14.757 C 36.000 15.001,35.807 15.200,35.571 15.200 C 35.018 15.200,34.000 16.218,34.000 16.771 C 34.000 17.007,33.638 17.200,33.195 17.200 C 32.752 17.200,31.494 18.100,30.400 19.200 C 29.306 20.300,28.228 21.200,28.005 21.200 C 27.782 21.200,27.600 21.470,27.600 21.800 C 27.600 22.130,27.330 22.400,27.000 22.400 C 26.670 22.400,26.397 22.625,26.394 22.900 C 26.390 23.233,26.258 23.200,26.000 22.800 C 25.632 22.231,25.375 22.977,25.553 24.100 C 25.579 24.265,25.465 24.379,25.300 24.353 C 24.392 24.209,23.939 24.463,24.145 25.000 C 24.314 25.442,24.088 25.602,23.287 25.606 C 22.438 25.611,22.332 25.697,22.800 26.000 C 23.200 26.258,23.233 26.390,22.900 26.394 C 22.625 26.397,22.400 26.670,22.400 27.000 C 22.400 27.330,22.130 27.600,21.800 27.600 C 21.470 27.600,21.200 27.782,21.200 28.005 C 21.200 28.228,20.288 29.318,19.174 30.426 C 18.059 31.535,17.122 32.780,17.091 33.193 C 17.059 33.607,16.923 33.876,16.788 33.793 C 16.482 33.604,15.200 35.067,15.200 35.605 C 15.200 35.822,14.975 36.001,14.700 36.003 C 14.180 36.006,13.200 37.764,13.200 38.692 C 13.200 38.985,12.930 39.329,12.600 39.455 C 12.270 39.582,12.000 40.026,12.000 40.443 C 12.000 40.859,11.730 41.200,11.400 41.200 C 11.070 41.200,10.800 41.532,10.800 41.939 C 10.800 42.897,9.650 45.200,9.171 45.200 C 8.967 45.200,8.800 45.470,8.800 45.800 C 8.800 46.130,8.620 46.400,8.400 46.400 C 8.180 46.400,8.000 46.959,8.000 47.643 C 8.000 48.583,7.854 48.830,7.400 48.655 C 6.973 48.491,6.786 48.709,6.750 49.413 C 6.662 51.152,6.573 51.402,6.082 51.300 C 5.791 51.240,5.600 51.675,5.600 52.400 C 5.600 53.060,5.420 53.600,5.200 53.600 C 4.980 53.600,4.821 53.735,4.847 53.900 C 5.044 55.145,4.719 56.400,4.200 56.400 C 3.779 56.400,3.600 56.825,3.600 57.824 C 3.600 58.607,3.448 59.153,3.263 59.039 C 3.077 58.924,2.893 59.764,2.852 60.905 C 2.805 62.256,2.573 63.095,2.189 63.310 C 1.852 63.499,1.600 64.216,1.600 64.987 C 1.600 65.727,1.406 66.398,1.169 66.477 C 0.270 66.777,0.223 72.977,0.160 199.400 C 0.094 333.134,0.095 333.200,1.039 333.200 C 1.347 333.200,1.579 333.335,1.553 333.500 C 1.320 334.974,1.678 336.800,2.200 336.800 C 2.661 336.800,2.800 337.311,2.800 339.000 C 2.800 340.210,2.980 341.200,3.200 341.200 C 3.420 341.200,3.600 341.746,3.600 342.413 C 3.600 343.121,3.849 343.721,4.200 343.855 C 4.530 343.982,4.800 344.429,4.800 344.848 C 4.800 345.613,4.897 345.868,6.132 348.332 C 6.500 349.065,6.800 350.030,6.800 350.475 C 6.800 351.031,6.988 351.213,7.400 351.055 C 7.852 350.882,8.000 351.125,8.000 352.041 C 8.000 352.710,8.272 353.529,8.604 353.861 C 8.936 354.193,9.104 354.631,8.978 354.835 C 8.852 355.039,9.031 355.314,9.375 355.446 C 9.719 355.578,10.000 355.936,10.000 356.243 C 10.000 356.549,10.160 356.800,10.357 356.800 C 10.553 356.800,10.826 357.250,10.964 357.800 C 11.102 358.350,11.392 358.800,11.608 358.800 C 11.823 358.800,12.000 359.250,12.000 359.800 C 12.000 360.350,12.191 360.800,12.424 360.800 C 12.657 360.800,12.719 360.592,12.562 360.338 C 12.385 360.052,12.452 359.985,12.738 360.162 C 12.992 360.319,13.200 360.797,13.200 361.224 C 13.200 361.651,13.380 362.000,13.600 362.000 C 13.820 362.000,14.000 362.281,14.000 362.624 C 14.000 362.998,14.187 363.132,14.468 362.958 C 14.783 362.764,14.852 362.887,14.681 363.334 C 14.540 363.700,14.569 364.000,14.745 364.000 C 14.921 364.000,15.306 364.450,15.600 365.000 C 15.894 365.550,16.375 366.000,16.668 366.000 C 16.969 366.000,17.200 366.434,17.200 367.000 C 17.200 367.622,17.427 368.000,17.800 368.000 C 18.130 368.000,18.400 368.270,18.400 368.600 C 18.400 368.930,18.580 369.200,18.800 369.200 C 19.020 369.200,19.200 369.470,19.200 369.800 C 19.200 370.130,19.393 370.400,19.629 370.400 C 20.182 370.400,21.200 371.418,21.200 371.971 C 21.200 372.207,21.470 372.400,21.800 372.400 C 22.130 372.400,22.400 372.681,22.400 373.024 C 22.400 373.367,22.548 373.556,22.729 373.444 C 23.096 373.217,24.400 374.590,24.400 375.205 C 24.400 375.422,24.593 375.600,24.829 375.600 C 25.382 375.600,26.400 376.618,26.400 377.171 C 26.400 377.407,26.670 377.600,27.000 377.600 C 27.330 377.600,27.600 377.870,27.600 378.200 C 27.600 378.530,27.793 378.800,28.029 378.800 C 28.582 378.800,29.600 379.818,29.600 380.371 C 29.600 380.607,29.870 380.800,30.200 380.800 C 30.530 380.800,30.800 380.980,30.800 381.200 C 30.800 381.420,31.250 381.600,31.800 381.600 C 32.422 381.600,32.800 381.827,32.800 382.200 C 32.800 382.530,32.980 382.800,33.200 382.800 C 33.758 382.800,35.185 384.282,34.900 384.567 C 34.772 384.695,35.237 384.800,35.933 384.800 C 36.630 384.800,37.200 384.993,37.200 385.229 C 37.200 385.782,38.218 386.800,38.771 386.800 C 39.007 386.800,39.203 387.115,39.206 387.500 C 39.211 388.098,39.269 388.113,39.600 387.600 C 39.858 387.200,39.990 387.167,39.994 387.500 C 39.997 387.775,40.270 388.000,40.600 388.000 C 40.930 388.000,41.200 388.162,41.200 388.361 C 41.200 388.559,41.731 388.907,42.380 389.133 C 43.029 389.359,43.879 389.917,44.269 390.372 C 44.659 390.828,45.262 391.200,45.609 391.200 C 45.956 391.200,46.482 391.425,46.779 391.700 C 47.210 392.100,47.261 392.100,47.035 391.700 C 46.880 391.425,46.943 391.200,47.176 391.200 C 47.409 391.200,47.600 391.380,47.600 391.600 C 47.600 391.820,48.050 392.000,48.600 392.000 C 49.202 392.000,49.600 392.228,49.600 392.573 C 49.600 392.902,50.070 393.201,50.700 393.273 C 51.319 393.345,51.756 393.619,51.700 393.900 C 51.634 394.228,52.116 394.402,53.100 394.406 C 54.166 394.410,54.432 394.518,54.020 394.779 C 53.607 395.040,53.953 395.183,55.220 395.273 C 56.380 395.356,56.965 395.574,56.900 395.900 C 56.812 396.342,57.791 396.571,59.500 396.507 C 59.775 396.497,60.000 396.649,60.000 396.844 C 60.000 397.040,60.643 397.200,61.429 397.200 C 62.214 397.200,63.127 397.470,63.457 397.800 C 63.787 398.130,64.764 398.400,65.629 398.400 C 66.642 398.400,67.200 398.583,67.200 398.914 C 67.200 399.662,66.839 399.647,88.700 399.855 L 108.800 400.047 108.804 284.124 C 108.808 167.637,108.877 161.356,110.239 153.400 C 110.579 151.420,110.951 148.990,111.067 148.000 C 111.183 147.010,111.440 146.029,111.639 145.820 C 111.837 145.611,112.000 145.047,112.000 144.566 C 112.000 144.085,112.284 142.726,112.631 141.546 C 112.979 140.366,113.556 138.410,113.914 137.200 C 114.271 135.990,114.707 134.829,114.882 134.620 C 115.057 134.411,115.200 133.922,115.200 133.534 C 115.200 133.145,115.495 132.146,115.855 131.314 C 116.216 130.481,116.656 129.440,116.834 129.000 C 118.367 125.198,121.379 118.887,123.228 115.600 C 124.866 112.690,128.089 107.452,128.397 107.200 C 128.532 107.090,129.031 106.370,129.505 105.600 C 129.980 104.830,130.781 103.720,131.284 103.134 C 131.788 102.547,133.168 100.815,134.352 99.285 C 136.609 96.365,146.376 86.553,149.800 83.765 C 152.892 81.247,159.147 76.800,159.597 76.800 C 159.819 76.800,160.000 76.652,160.000 76.471 C 160.000 76.290,160.765 75.743,161.700 75.256 C 163.589 74.271,164.897 73.503,165.200 73.200 C 165.310 73.090,166.390 72.484,167.600 71.852 C 168.810 71.221,171.060 70.044,172.600 69.236 C 176.370 67.259,181.151 65.200,181.972 65.200 C 182.339 65.200,182.811 65.052,183.020 64.871 C 183.229 64.690,184.480 64.223,185.800 63.834 C 187.120 63.445,188.781 62.953,189.491 62.740 C 200.000 59.600,218.953 59.898,230.400 63.384 C 231.610 63.752,233.097 64.152,233.705 64.273 C 234.313 64.394,234.908 64.651,235.029 64.846 C 235.149 65.041,235.524 65.200,235.863 65.200 C 236.792 65.200,246.340 69.699,249.288 71.526 C 251.567 72.938,256.206 76.213,256.333 76.500 C 256.407 76.665,256.707 76.800,257.000 76.800 C 257.293 76.800,257.593 76.936,257.667 77.103 C 257.740 77.270,258.610 78.028,259.600 78.789 C 265.971 83.684,273.560 90.792,278.831 96.801 C 282.195 100.635,286.800 106.299,286.800 106.602 C 286.800 106.730,287.250 107.320,287.800 107.913 C 288.350 108.507,288.800 109.219,288.800 109.496 C 288.800 109.773,288.961 110.000,289.159 110.000 C 289.356 110.000,290.378 111.395,291.429 113.100 C 294.164 117.532,296.301 119.416,300.600 121.183 C 301.040 121.364,302.570 121.833,304.000 122.226 C 305.430 122.619,306.780 123.066,307.000 123.220 C 307.220 123.374,307.940 123.600,308.600 123.723 C 309.260 123.846,310.790 124.244,312.000 124.609 C 313.210 124.973,314.920 125.451,315.800 125.670 C 316.680 125.889,317.760 126.217,318.200 126.398 C 318.640 126.580,319.854 127.060,320.899 127.464 C 321.943 127.869,322.798 128.335,322.799 128.500 C 322.799 128.665,322.988 128.800,323.217 128.800 C 324.552 128.800,331.600 135.408,331.600 136.660 C 331.600 136.920,331.735 137.193,331.900 137.267 C 332.065 137.340,332.535 138.120,332.944 139.000 C 333.354 139.880,333.856 140.924,334.060 141.320 C 335.250 143.625,335.937 150.838,335.210 153.389 C 334.958 154.275,334.462 155.990,334.109 157.200 C 332.670 162.124,328.027 167.768,322.779 170.976 C 321.360 171.842,320.140 172.697,320.067 172.876 C 319.993 173.054,319.693 173.200,319.400 173.200 C 319.107 173.200,318.807 173.338,318.733 173.507 C 318.660 173.676,317.610 174.435,316.400 175.194 C 315.190 175.953,314.110 176.670,314.000 176.787 C 313.730 177.074,312.341 177.940,311.600 178.282 C 311.270 178.435,310.666 178.870,310.257 179.249 C 309.849 179.629,308.409 180.617,307.057 181.445 C 305.706 182.274,304.540 183.097,304.467 183.276 C 304.393 183.454,304.106 183.600,303.829 183.600 C 302.119 183.600,302.078 184.032,301.833 204.600 C 301.612 223.093,301.418 227.783,300.473 237.400 C 299.870 243.536,298.157 254.462,297.570 255.919 C 297.367 256.424,297.202 257.324,297.205 257.919 C 297.212 259.343,295.994 265.100,294.608 270.200 C 294.309 271.300,293.746 273.640,293.356 275.400 C 292.967 277.160,292.503 278.771,292.324 278.980 C 292.146 279.189,292.000 279.705,292.000 280.126 C 292.000 280.902,290.952 284.454,290.371 285.651 C 290.197 286.009,289.932 286.956,289.782 287.755 C 289.632 288.555,289.350 289.307,289.155 289.428 C 288.960 289.549,288.800 290.076,288.800 290.600 C 288.800 291.124,288.620 291.664,288.400 291.800 C 288.180 291.936,287.999 292.352,287.998 292.724 C 287.996 293.096,287.726 293.916,287.398 294.546 C 287.069 295.176,286.800 295.996,286.800 296.369 C 286.800 296.742,286.536 297.396,286.213 297.824 C 285.890 298.251,285.620 299.005,285.613 299.500 C 285.606 299.995,285.420 300.400,285.200 300.400 C 284.980 300.400,284.800 300.664,284.800 300.986 C 284.800 301.590,284.451 302.437,282.080 307.600 C 280.908 310.150,279.848 312.035,276.116 318.200 C 275.849 318.640,275.502 319.270,275.344 319.600 C 274.347 321.679,266.798 333.330,266.316 333.533 C 266.142 333.607,266.000 333.826,266.000 334.022 C 266.000 334.353,263.673 337.958,263.174 338.400 C 263.050 338.510,261.896 340.040,260.609 341.800 C 259.322 343.560,258.163 345.090,258.032 345.200 C 257.902 345.310,257.267 346.120,256.620 347.000 C 255.533 348.481,254.739 349.443,253.200 351.145 C 252.870 351.510,252.180 352.347,251.666 353.004 C 248.389 357.202,234.591 371.053,223.400 381.381 C 215.929 388.275,204.400 399.421,204.400 399.750 C 204.400 400.036,326.892 399.995,330.500 399.709 C 332.124 399.580,332.800 399.360,332.800 398.963 C 332.800 398.548,333.374 398.400,334.987 398.400 C 336.651 398.400,337.126 398.272,336.969 397.864 C 336.815 397.463,337.293 397.309,338.865 397.254 C 340.020 397.213,341.063 397.022,341.183 396.830 C 341.302 396.638,341.850 396.413,342.400 396.331 C 342.950 396.248,343.368 395.998,343.328 395.775 C 343.289 395.552,343.686 395.334,344.210 395.291 C 345.614 395.175,346.176 395.032,346.403 394.733 C 346.515 394.587,347.235 394.388,348.003 394.291 C 348.771 394.195,349.355 393.910,349.300 393.658 C 349.245 393.406,349.661 393.200,350.224 393.200 C 350.787 393.200,351.148 393.039,351.026 392.842 C 350.773 392.433,351.701 392.000,352.833 392.000 C 353.255 392.000,353.600 391.820,353.600 391.600 C 353.600 391.380,354.050 391.200,354.600 391.200 C 355.222 391.200,355.600 390.973,355.600 390.600 C 355.600 390.270,355.870 390.000,356.200 390.000 C 356.530 390.000,356.800 389.820,356.800 389.600 C 356.800 389.380,357.250 389.200,357.800 389.200 C 358.422 389.200,358.800 388.973,358.800 388.600 C 358.800 388.264,359.157 388.000,359.613 388.000 C 360.059 388.000,360.529 387.730,360.655 387.400 C 360.782 387.070,361.136 386.800,361.443 386.800 C 361.749 386.800,362.000 386.640,362.000 386.443 C 362.000 386.247,362.450 385.974,363.000 385.836 C 363.550 385.698,364.000 385.408,364.000 385.192 C 364.000 384.977,364.193 384.800,364.429 384.800 C 364.982 384.800,366.000 383.782,366.000 383.229 C 366.000 382.993,366.356 382.800,366.791 382.800 C 367.226 382.800,368.588 381.810,369.818 380.600 C 371.047 379.390,372.232 378.400,372.450 378.400 C 372.669 378.400,372.719 378.192,372.562 377.938 C 372.391 377.663,372.451 377.585,372.711 377.745 C 372.949 377.892,373.260 377.827,373.400 377.600 C 373.540 377.373,373.823 377.291,374.028 377.417 C 374.343 377.612,374.574 376.834,374.463 375.947 C 374.446 375.808,374.739 375.718,375.116 375.747 C 375.539 375.780,375.779 375.533,375.744 375.100 C 375.691 374.424,376.046 374.233,377.100 374.370 C 377.386 374.407,377.600 374.000,377.600 373.418 C 377.600 372.780,377.824 372.400,378.200 372.400 C 378.530 372.400,378.800 372.207,378.800 371.971 C 378.800 371.418,379.818 370.400,380.371 370.400 C 380.607 370.400,380.800 370.130,380.800 369.800 C 380.800 369.470,380.980 369.200,381.200 369.200 C 381.420 369.200,381.600 368.840,381.600 368.400 C 381.600 367.956,381.867 367.600,382.200 367.600 C 382.533 367.600,382.800 367.244,382.800 366.800 C 382.800 366.356,383.067 366.000,383.400 366.000 C 383.730 366.000,384.000 365.854,384.000 365.675 C 384.000 365.497,384.367 364.957,384.816 364.475 C 385.264 363.994,385.434 363.600,385.192 363.600 C 384.950 363.600,384.866 363.417,385.004 363.193 C 385.142 362.970,385.423 362.891,385.628 363.017 C 385.832 363.144,386.000 362.967,386.000 362.624 C 386.000 362.281,386.180 362.000,386.400 362.000 C 386.620 362.000,386.800 361.651,386.800 361.224 C 386.800 360.286,387.444 359.796,387.754 360.498 C 387.905 360.838,387.965 360.806,387.941 360.400 C 387.869 359.195,388.011 358.800,388.515 358.800 C 388.798 358.800,389.060 358.398,389.097 357.906 C 389.134 357.414,389.352 356.949,389.582 356.873 C 389.812 356.796,390.000 356.318,390.000 355.809 C 390.000 355.301,390.270 354.782,390.600 354.655 C 390.930 354.529,391.200 353.969,391.200 353.413 C 391.200 352.856,391.380 352.400,391.600 352.400 C 391.820 352.400,392.000 351.950,392.000 351.400 C 392.000 350.850,392.227 350.400,392.504 350.400 C 393.185 350.400,394.163 348.829,394.246 347.600 C 394.404 345.279,394.381 345.350,394.779 345.980 C 395.040 346.393,395.183 346.047,395.273 344.780 C 395.356 343.620,395.574 343.035,395.900 343.100 C 396.191 343.158,396.400 342.791,396.400 342.224 C 396.400 341.687,396.580 341.136,396.800 341.000 C 397.020 340.864,397.200 339.928,397.200 338.920 C 397.200 337.661,397.419 336.909,397.900 336.514 C 398.328 336.163,398.367 336.053,398.000 336.229 C 397.513 336.463,397.494 336.416,397.900 335.979 C 398.175 335.682,398.400 334.756,398.400 333.920 C 398.400 332.917,398.570 332.434,398.900 332.500 C 399.780 332.676,399.792 330.892,399.796 198.268 C 399.800 74.601,399.764 67.909,399.100 67.424 C 398.607 67.063,398.400 66.362,398.400 65.056 C 398.400 63.673,398.247 63.200,397.800 63.200 C 397.383 63.200,397.200 62.780,397.200 61.824 C 397.200 61.067,397.020 60.336,396.800 60.200 C 396.580 60.064,396.400 59.333,396.400 58.576 C 396.400 57.620,396.217 57.200,395.800 57.200 C 395.379 57.200,395.200 56.775,395.200 55.776 C 395.200 54.993,395.040 54.451,394.845 54.572 C 394.650 54.693,394.498 54.568,394.508 54.296 C 394.564 52.743,394.335 52.000,393.800 52.000 C 393.470 52.000,393.200 51.809,393.200 51.576 C 393.200 51.343,393.363 51.254,393.563 51.377 C 393.762 51.500,393.717 51.152,393.463 50.604 C 393.208 50.055,392.775 49.605,392.500 49.603 C 392.225 49.601,392.000 49.150,392.000 48.600 C 392.000 48.050,391.820 47.600,391.600 47.600 C 391.380 47.600,391.200 47.150,391.200 46.600 C 391.200 45.978,390.973 45.600,390.600 45.600 C 390.204 45.600,390.000 45.204,390.000 44.433 C 390.000 43.792,389.834 43.207,389.630 43.133 C 389.427 43.060,389.202 42.745,389.130 42.433 C 389.059 42.122,388.689 41.541,388.309 41.142 C 387.929 40.744,387.724 40.142,387.854 39.805 C 388.023 39.363,387.909 39.260,387.445 39.438 C 387.010 39.605,386.800 39.467,386.800 39.014 C 386.800 38.260,385.882 37.200,385.229 37.200 C 384.993 37.200,384.800 36.763,384.800 36.229 C 384.800 35.670,384.376 34.925,383.800 34.471 C 383.250 34.039,382.800 33.396,382.800 33.042 C 382.800 32.689,382.530 32.400,382.200 32.400 C 381.867 32.400,381.600 32.044,381.600 31.600 C 381.600 31.160,381.420 30.800,381.200 30.800 C 380.980 30.800,380.800 30.530,380.800 30.200 C 380.800 29.870,380.607 29.600,380.371 29.600 C 379.818 29.600,378.800 28.582,378.800 28.029 C 378.800 27.793,378.530 27.600,378.200 27.600 C 377.870 27.600,377.600 27.319,377.600 26.976 C 377.600 26.633,377.452 26.444,377.271 26.556 C 376.904 26.783,375.600 25.410,375.600 24.795 C 375.600 24.578,375.407 24.400,375.171 24.400 C 374.618 24.400,373.600 23.382,373.600 22.829 C 373.600 22.593,373.330 22.400,373.000 22.400 C 372.670 22.400,372.400 22.130,372.400 21.800 C 372.400 21.470,372.207 21.200,371.971 21.200 C 371.398 21.200,370.400 20.175,370.400 19.586 C 370.400 19.327,370.130 19.218,369.800 19.345 C 369.435 19.485,369.200 19.345,369.200 18.987 C 369.200 18.621,368.808 18.400,368.157 18.400 C 367.395 18.400,367.176 18.239,367.345 17.800 C 367.501 17.392,367.323 17.200,366.787 17.200 C 366.354 17.200,366.000 16.969,366.000 16.686 C 366.000 16.014,363.960 14.849,363.236 15.108 C 362.846 15.247,362.750 15.108,362.924 14.655 C 363.086 14.232,362.967 14.000,362.587 14.000 C 362.264 14.000,362.000 13.820,362.000 13.600 C 362.000 13.380,361.668 13.200,361.261 13.200 C 360.419 13.200,358.800 11.927,358.800 11.266 C 358.800 11.023,358.553 10.920,358.252 11.036 C 357.950 11.151,357.423 10.966,357.080 10.623 C 356.737 10.280,356.090 10.000,355.641 10.000 C 355.080 10.000,354.897 9.812,355.055 9.400 C 355.215 8.984,355.028 8.800,354.443 8.800 C 353.979 8.800,353.600 8.620,353.600 8.400 C 353.600 8.180,353.223 8.000,352.762 8.000 C 351.967 8.000,349.635 6.909,349.196 6.332 C 349.084 6.184,348.454 5.934,347.796 5.776 C 347.138 5.619,346.420 5.382,346.200 5.251 C 345.734 4.973,345.486 4.918,344.400 4.850 C 343.960 4.823,343.600 4.530,343.600 4.200 C 343.600 3.800,343.200 3.600,342.400 3.600 C 341.740 3.600,341.200 3.420,341.200 3.200 C 341.200 2.980,340.499 2.800,339.643 2.800 C 338.628 2.800,338.005 2.591,337.855 2.200 C 337.683 1.750,336.961 1.600,334.970 1.600 C 332.895 1.600,332.360 1.481,332.523 1.056 C 332.683 0.639,332.024 0.452,329.706 0.256 C 326.616 -0.005,73.680 0.033,69.500 0.296 M199.600 94.674 C 198.390 94.994,196.680 95.446,195.800 95.680 C 191.876 96.720,189.676 97.644,183.600 100.809 C 182.610 101.325,180.470 102.613,178.845 103.673 C 177.219 104.733,175.734 105.600,175.545 105.600 C 175.355 105.600,175.200 105.741,175.200 105.914 C 175.200 106.086,174.628 106.566,173.928 106.979 C 170.765 108.847,160.974 118.606,157.652 123.200 C 156.300 125.070,155.015 126.817,154.797 127.083 C 154.579 127.349,154.400 127.754,154.400 127.983 C 154.400 128.212,154.220 128.400,154.000 128.400 C 153.780 128.400,153.600 128.657,153.600 128.971 C 153.600 129.286,153.375 129.789,153.100 130.090 C 152.458 130.792,151.027 133.438,149.904 136.000 C 149.567 136.770,148.841 138.390,148.291 139.600 C 147.741 140.810,146.975 142.880,146.589 144.200 C 146.204 145.520,145.749 146.960,145.578 147.400 C 144.830 149.333,144.138 152.566,143.225 158.400 C 142.925 160.317,142.594 346.084,142.798 397.903 C 142.800 398.375,144.078 397.925,144.800 397.199 C 145.034 396.964,149.480 394.002,150.492 393.407 C 151.819 392.627,159.057 387.618,159.878 386.911 C 160.333 386.520,162.105 385.120,163.816 383.800 C 166.776 381.517,176.100 374.143,177.800 372.741 C 182.641 368.749,189.238 363.107,191.796 360.769 C 192.898 359.762,194.519 358.322,195.397 357.569 C 197.461 355.800,216.093 337.217,218.426 334.600 C 219.407 333.500,221.287 331.340,222.605 329.800 C 223.922 328.260,225.095 326.910,225.210 326.800 C 225.326 326.690,226.041 325.790,226.800 324.800 C 227.559 323.810,228.294 322.910,228.434 322.800 C 228.575 322.690,230.185 320.530,232.012 318.000 C 233.840 315.470,235.446 313.310,235.581 313.200 C 235.716 313.090,236.444 312.010,237.200 310.800 C 237.956 309.590,238.670 308.510,238.787 308.400 C 239.089 308.116,239.957 306.710,240.268 306.000 C 240.412 305.670,240.906 304.864,241.365 304.208 C 242.313 302.855,242.983 301.760,243.572 300.600 C 243.795 300.160,244.705 298.540,245.593 297.000 C 247.131 294.332,249.168 290.246,251.576 285.000 C 252.557 282.864,253.120 281.507,254.485 278.000 C 254.699 277.450,255.127 276.490,255.437 275.868 C 255.747 275.245,256.000 274.400,256.000 273.991 C 256.000 273.582,256.166 273.145,256.369 273.019 C 256.572 272.894,256.865 272.214,257.020 271.509 C 257.175 270.803,257.442 269.950,257.615 269.613 C 257.787 269.276,258.416 267.380,259.014 265.400 C 259.611 263.420,260.278 261.260,260.494 260.600 C 260.711 259.940,261.039 258.770,261.222 258.000 C 261.406 257.230,261.847 255.430,262.202 254.000 C 262.558 252.570,263.019 250.464,263.227 249.319 C 263.435 248.175,263.784 246.768,264.002 246.193 C 264.221 245.618,264.400 244.587,264.400 243.902 C 264.400 243.217,264.569 242.104,264.776 241.428 C 265.214 239.994,265.921 234.752,266.479 228.800 C 266.695 226.490,266.991 211.588,267.136 195.685 C 267.308 176.831,267.542 166.671,267.807 166.485 C 271.198 164.109,280.589 158.000,280.851 158.000 C 281.043 158.000,281.203 157.865,281.206 157.700 C 281.209 157.535,282.287 156.770,283.600 156.000 C 284.913 155.230,285.991 154.465,285.994 154.300 C 285.997 154.135,286.242 154.000,286.538 154.000 C 286.834 154.000,287.402 153.640,287.800 153.200 C 288.439 152.493,288.448 152.400,287.876 152.400 C 287.519 152.400,286.546 152.105,285.714 151.745 C 284.881 151.384,283.750 150.894,283.200 150.656 C 281.967 150.122,275.075 146.011,274.800 145.645 C 274.690 145.499,273.808 144.763,272.841 144.009 C 271.873 143.255,270.253 141.748,269.241 140.659 C 268.228 139.570,267.211 138.482,266.980 138.240 C 265.995 137.208,263.200 133.199,263.200 132.817 C 263.200 132.588,263.065 132.397,262.900 132.394 C 262.735 132.391,261.970 131.313,261.200 130.000 C 260.430 128.687,259.665 127.609,259.500 127.606 C 259.335 127.603,259.200 127.345,259.200 127.033 C 259.200 126.722,259.028 126.407,258.818 126.333 C 258.608 126.260,257.840 125.359,257.111 124.332 C 253.341 119.018,242.150 107.831,237.800 105.027 C 237.140 104.601,236.346 104.000,236.036 103.691 C 235.726 103.382,234.736 102.668,233.836 102.105 C 232.936 101.541,232.110 100.968,232.000 100.831 C 231.659 100.404,225.097 97.322,223.200 96.697 C 221.373 96.095,220.175 95.765,215.706 94.632 C 212.475 93.813,202.763 93.839,199.600 94.674 M228.787 146.280 C 235.299 148.723,241.991 155.813,241.998 160.276 C 241.999 160.758,242.180 161.264,242.400 161.400 C 242.623 161.538,242.800 163.396,242.800 165.600 C 242.800 167.804,242.623 169.662,242.400 169.800 C 242.180 169.936,242.000 170.573,242.000 171.215 C 242.000 172.376,239.837 176.879,239.156 177.133 C 238.960 177.207,238.800 177.459,238.800 177.694 C 238.800 178.412,234.670 182.153,232.986 182.961 C 232.114 183.379,230.922 183.964,230.338 184.261 C 229.754 184.557,228.935 184.800,228.518 184.800 C 228.101 184.800,227.569 184.991,227.336 185.224 C 226.773 185.787,218.027 185.787,217.464 185.224 C 217.231 184.991,216.660 184.800,216.196 184.800 C 215.733 184.800,215.004 184.536,214.576 184.213 C 214.149 183.890,213.485 183.620,213.100 183.613 C 212.715 183.606,212.400 183.432,212.400 183.227 C 212.400 183.022,212.038 182.739,211.597 182.599 C 207.041 181.153,202.304 172.488,202.304 165.600 C 202.304 158.688,204.491 154.249,210.400 149.171 C 211.545 148.187,215.254 146.400,216.151 146.400 C 216.482 146.400,216.864 146.220,217.000 146.000 C 217.441 145.287,226.726 145.507,228.787 146.280 " stroke="none" fill="#1bab73" fill-rule="evenodd"/></g></svg>';
		// Encode SVG to show the icon with the menu.
		$svg_icon = 'data:image/svg+xml;base64,' . base64_encode( $svg_heyzine ); // phpcs:ignore

		add_menu_page(
			'Heyzine',
			'Heyzine', 
			'manage_options',
			'heyzine',
			array( $this, 'render_settings_page' ),
			$svg_icon,
			81 // Position after Settings.
		);

		if ($this->get_db_oauth_token() ) {
			add_submenu_page(
				'heyzine',
				__('General', 'pdf-flipbook-heyzine'),
				__('General', 'pdf-flipbook-heyzine'),
				'manage_options',
				'heyzine',
				array( $this, 'render_settings_page' )
			);

			add_submenu_page(
				'heyzine',
				__('Add New Flipbook', 'pdf-flipbook-heyzine'),
				__('Add New Flipbook', 'pdf-flipbook-heyzine'),
				'manage_options',
				'heyzine&hzaction=new',
				array( $this, 'render_settings_page_create_flipbook' )
			);
		}
	}

	/**
	 * Get heyzine flipbooks from Heyzine API.
	 */
	public function get_api_heyzines() {
		$flipbook_list = $this->get_flipbook_list();

		if ( is_array( $flipbook_list ) ) {
			$flipbook_list = array_map(
				function ( $flipbook ) {
					return array(
						'id'             => $flipbook['id'],
						'date'           => $flipbook['date'],
						'title'          => $flipbook['title'],
						'subtitle'       => $flipbook['subtitle'],
						'description'    => $flipbook['description'],
						'private'        => $flipbook['private'],
						'pages'          => $flipbook['pages'],
						'link_custom'    => $flipbook['links']['custom'],
						'link_base'      => $flipbook['links']['base'],
						'link_thumbnail' => $flipbook['links']['thumbnail'],
						'link_pdf'       => $flipbook['links']['pdf'],
					);
				},
				$flipbook_list
			);
		}

		return rest_ensure_response( $flipbook_list );
	}

	/**
	 * Check if the current user has the correct permissions to view the private data from API.
	 */
	public function get_private_data_permissions_check() {
		// Restrict endpoint to only users who have the edit_posts capability.
		if ( ! current_user_can( 'edit_posts' ) ) {
			return new WP_Error(
				'rest_forbidden',
				esc_html__( 'You can not view this private data.', 'pdf-flipbook-heyzine' ),
				array( 'status' => 401 )
			);
		}

		// This is a black-listing approach. You could alternatively do this via white-listing, by returning false here and changing the permissions check.
		return true;
	}

	/**
	 * Get heyzine flipbook from Heyzine API.
	 *
	 * @param WP_REST_Request $request The request object.
	 */
	public function get_api_heyzine( $request ) {
		$flipbook_id = (string) $request['id'];
		$flipbook    = $this->get_flipbook( $flipbook_id );

		if ( is_array( $flipbook ) ) {
			return rest_ensure_response(
				array(
					'id'             => $flipbook['id'],
					'date'           => $flipbook['date'],
					'title'          => $flipbook['title'],
					'subtitle'       => $flipbook['subtitle'],
					'description'    => $flipbook['description'],
					'private'        => $flipbook['private'],
					'tags'           => $flipbook['tags'],
					'oembed'         => $flipbook['oembed'],
					'link_custom'    => $flipbook['links']['custom'],
					'link_base'      => $flipbook['links']['base'],
					'link_thumbnail' => $flipbook['links']['thumbnail'],
					'link_pdf'       => $flipbook['links']['pdf'],
				)
			);
		} else {
			return new WP_Error(
				'rest_heyzine_invalid',
				esc_html__( 'The flipbook does not exist.', 'pdf-flipbook-heyzine' ),
				array( 'status' => 404 )
			);
		}
	}

	/**
	 * Get heyzine flipbook from Heyzine API.
	 *
	 * @param WP_REST_Request $request The request object.
	 */
	public function get_api_flipbook_state( $request ) {
		$flipbook_id = (string) $request['id'];


		$res = wp_remote_get(
			$this->base_url . $this->api_flipbook_state . '?name=' . $flipbook_id,
			array(
				'headers' => array(
					'Authorization' => 'Bearer ' . $this->get_db_oauth_token(),
				),
			)
		);

		if ( is_wp_error( $res ) ) {
			$data = $res->get_error_message();
		} else {
			$data = json_decode( wp_remote_retrieve_body( $res ), true );
		}

		if ( is_array( $data ) ) {
			return rest_ensure_response(
				array(
					'state'             => $data['state'],
					'msg'           => $data['msg'],
					'id'            => $data['id'],
				)
			);
		} else {
			return new WP_Error(
				'rest_heyzine_state_invalid',
				esc_html__( 'The flipbook state is invalid.', 'pdf-flipbook-heyzine' ),
				array( 'status' => 404 )
			);
		}
	}	

/**
	 * Save heyzine flipbook settings with the Heyzine API.
	 *
	 * @param WP_REST_Request $request The request object.
	 */
	public function update_api_flipbook_settings( $request ) {
		
		$flipbook_id = (string) $request['id'];
		$title = (string) $request['title'];
		$subtitle = (string) $request['subtitle']; 
		$effect = (string) $request['effect'];

		$res = wp_remote_post(
			$this->base_url . $this->api_flipbook_settings . '?name=' . $flipbook_id,
			array(
				'headers' => array(
					'Authorization' => 'Bearer ' . $this->get_db_oauth_token(),
				),
				'body' => array(
					'title' => $title,
					'subtitle' => $subtitle,
					'effect' => $effect,
				),
			)
		);

		
		if ( is_wp_error( $res ) ) {
			$data = $res->get_error_message();
		} else {
			$data = json_decode( wp_remote_retrieve_body( $res ), true );
		}

		
		
		if ( is_array( $data ) ) {
			return rest_ensure_response(
				array(
					'success'       => $data['success'],
					'msg'           => $data['msg'],
				)
			);
		} else {
			return new WP_Error(
				'rest_heyzine_settings_invalid',
				esc_html__( 'The flipbook save was not possible.', 'pdf-flipbook-heyzine' ),
				array( 'status' => 404 )
			);
		}
	}

	/**
	 * Register the routes for the API.
	 */
	public function register_heyzine_routes() {
		// Registering route for flipbooks.
		register_rest_route(
			$this->heyzine_namespace,
			'/flipbooks',
			array(
				'methods'             => WP_REST_Server::READABLE,
				'callback'            => array( $this, 'get_api_heyzines' ),
				'permission_callback' => array( $this, 'get_private_data_permissions_check' ),
			)
		);

		// Registering route for single flipbook. The (?P<id>[\w-.]+) is our path variable for the ID, which, in this example, can only be some form of positive number.
		register_rest_route(
			$this->heyzine_namespace,
			'/flipbooks/(?P<id>[\w\-\.]+)',
			array(
				'methods'             => WP_REST_Server::READABLE,
				'callback'            => array( $this, 'get_api_heyzine' ),
				'permission_callback' => array( $this, 'get_private_data_permissions_check' ),
			)
		);

		register_rest_route(
			$this->heyzine_namespace,
			'/flipbook-state/(?P<id>[\w\-\.]+)',
			array(
				'methods'             => WP_REST_Server::READABLE,
				'callback'            => array( $this, 'get_api_flipbook_state' ),
				'permission_callback' => array( $this, 'get_private_data_permissions_check' ),
			)
		);		

		register_rest_route(
			$this->heyzine_namespace,
			'/flipbook-settings/(?P<id>[\w\-\.]+)',
			array(
				'methods'             => WP_REST_Server::CREATABLE,
				'callback'            => array( $this, 'update_api_flipbook_settings' ),
				'permission_callback' => array( $this, 'get_private_data_permissions_check' ),
			)
		);			
	}

	/**
	 * Register the block for this plugin into the WordPress Gutenberg editor.
	 */
	public function heyzine_block() {
		register_block_type(
			CL_HEYZINE_PLUGIN_PATH . 'heyzine-block/build'
		);
	}

	/**
	 * Return the OAuth token stored in the database or false if it doesn't exist.
	 */
	private function get_db_oauth_token() {
		$token = get_option( 'cl_heyzine_oauth_token' );

		if ( $token ) {
			return $token;
		} else {
			return false;
		}
	}

	private function get_db_oauth_email() {
		$email = get_option( 'cl_heyzine_oauth_email' );

		if ( $email ) {
			return $email;
		} else {
			return false;
		}
	}

	/**
	 * Get the OAuth token from Heyzine API.
	 *
	 * @param string $code The code necesary to obtain Heyzine API token.
	 */
	private function get_api_token( string $code ) {
		$res = wp_remote_post(
			$this->base_url . $this->api_token,
			array(
				'body' => array(
					'grant_type'    => 'authorization_code',
					'client_id'     => $this->client_id,
					'client_secret' => $this->client_secret,
					'code'          => $code,
					'redirect_uri'  => $this->base_url,
				),
			)
		);

		if ( is_wp_error( $res ) ) {
			return $res->get_error_message();
		} else {
			return json_decode( wp_remote_retrieve_body( $res ), true );
		}
	}

	/**
	 * Create new Heyzine from Heyzine API.
	 */
	private function set_new_flipbook() {
		if (
			isset( $_POST['heyzine_new_nonce'] )
			&& wp_verify_nonce( sanitize_text_field( wp_unslash( $_POST['heyzine_new_nonce'] ) ), 'cl_heyzine_upload_file' )
		) {
			if ( esc_url_raw( $_POST['cl-heyzine-url'] ) ) {
				$res = wp_remote_post(
					$this->base_url . $this->api_new_flipbook,
					array(
						'body'    => array(
							'pdf' => esc_url_raw( $_POST['cl-heyzine-url'] ),
							'bg' => '#fff0',
						),
						'headers' => array(
							'Authorization' => 'Bearer ' . $this->get_db_oauth_token(),
						),
					)
				);

				if ( is_wp_error( $res ) ) {
					$response = $res;
				} else {
					$response = json_decode( wp_remote_retrieve_body( $res ), true );
				}
				
			} else {
				$response = new WP_Error(
					'url_file_not_valid',
					esc_html__( 'Error: File URL not valid', 'pdf-flipbook-heyzine' ),
				);
			}
		} else {
			$response = new WP_Error(
				'nonce_error',
				esc_html__( 'Error validating nonce', 'pdf-flipbook-heyzine' )
			);
		}

		return $response;
	}

	/**
	 * Get the list of flipbooks from Heyzine API.
	 */
	private function get_flipbook_list() {
	
		$res = wp_remote_get(
			$this->base_url . $this->api_flipbook_list,
			array(
				'headers' => array(
					'Authorization' => 'Bearer ' . $this->get_db_oauth_token(),
				),
			)
		);

		if ( is_wp_error( $res ) ) {
			$data = $res->get_error_message();
		} else {
			$data                  = json_decode( wp_remote_retrieve_body( $res ), true );
			$days_to_save_api_data = 1;
		}

		return $data;
	}

	/**
	 * Return cl-heyzine shortcode.
	 *
	 * @param array $atts The attributes of the shortcode.
	 */
	public function heyzine_shortcode( $atts ) {
		$res   = '';
		$style = '';
		$atts  = shortcode_atts(
			array(
				'responsive_width' => true,
				'flipbook_width'   => '800',
				'flipbook_height'  => '500',
				'heyzine_link'     => '',
				'heyzine_page'     => '0',

			),
			$atts,
			'cl_heyzine'
		);

		if ( empty( $atts['heyzine_link'] ) || ! wp_http_validate_url( $atts['heyzine_link'] ) ) {
			return null;
		}

		$style .= 'border: 0px;';
		if ( isset( $atts['flipbook_width'] ) ) {
			$style .= ' width: ' . absint( $atts['flipbook_width'] ) . 'px;';
		} else {
			$style .= ' width: 100%;';
		}
		$style .= ' height: ' . absint( $atts['flipbook_height'] ) . 'px;';

		$res .= '<div class="cl-heyzine-embed">';

		if ( empty( $atts['heyzine_page'] ) ) {
			$page = null;
		} else {
			$page = '#page/' . absint( $atts['heyzine_page'] );
		}

		$res .= '<iframe class="cl-heyzine-iframe fp-iframe" allowfullscreen="allowfullscreen" allow="fullscreen" style="' . $style . '" src="' . esc_url( $atts['heyzine_link'] . $page ) . '"></iframe>';
		$res .= '</div>';

		return $res;
	}

	/**
	 * Get a flipbook from Heyzine API.
	 *
	 * @param string $heyzine_id The ID of the flipbook.
	 */
	private function get_flipbook( $heyzine_id ) {
		$res = wp_remote_get(
			$this->base_url . $this->api_flipbook . '?id=' . $heyzine_id,
			array(
				'headers' => array(
					'Authorization' => 'Bearer ' . $this->get_db_oauth_token(),
				),
			)
		);

		if ( is_wp_error( $res ) ) {
			return $res->get_error_message();
		} else {
			return json_decode( wp_remote_retrieve_body( $res ), true );
		}
	}

	/**
	 * Save the OAuth token in the database.
	 *
	 * @param array $token_res The response from Heyzine API.
	 */
	public function save_token( $token_res ) {
		if ( is_array( $token_res ) ) {
			$access_token  = $token_res['access_token'];
			$refresh_token = $token_res['refresh_token'];
			$expires_in    = $token_res['expires_in'];
			$expires_at    = time() + $expires_in;

			update_option( 'cl_heyzine_oauth_token', $access_token, false );
			update_option( 'cl_heyzine_oauth_refresh_token', $refresh_token, false );
			update_option( 'cl_heyzine_oauth_token_expires_at', $expires_at, false );

			$res = wp_remote_get(
				$this->base_url . $this->api_me,
				array(
					'headers' => array(
						'Authorization' => 'Bearer ' . $this->get_db_oauth_token(),
					),
				)
			);
	
			if ( is_wp_error( $res ) ) {
				require_once CL_HEYZINE_PLUGIN_PATH . 'admin/partials/cl-heyzine-admin-error-token.php';
				exit;
			} else {
				$me = json_decode( wp_remote_retrieve_body( $res ), true );
				update_option( 'cl_heyzine_oauth_email', $me['email'], false );
			}			

			// Redirect to the settings page with javascript.
			echo '<script>window.location.href = "' . esc_url( $this->redirect_uri ) . '";</script>';

			// Show button to redirect setting page in case that js is disabled.
			echo '<br><a href="' . esc_url( $this->redirect_uri ) . '" class="button button-primary">' . esc_html__( 'Heyzine settings page', 'pdf-flipbook-heyzine' ) . '</a>';

			// Redirect to the settings page with PHP.
			wp_safe_redirect( $this->redirect_uri );
			exit;
		} else {
			require_once CL_HEYZINE_PLUGIN_PATH . 'admin/partials/cl-heyzine-admin-error-token.php';
		}
	}

	/**
	 * Render the settings page with the button to authenticate with Heyzine.
	 */
	private function render_settings_page_invalid_token() {
		$nonce = wp_create_nonce( $this->nonce_action );

		$oauth_url = $this->base_url . $this->api_auth . '?response_type=code&client_id=' . $this->client_id . '&state=' . $nonce . '&redirect_uri=' . $this->redirect_uri;

		if ( isset( $_GET['state'] ) ) {
			if ( wp_verify_nonce( sanitize_text_field( wp_unslash( $_GET['state'] ) ), $this->nonce_action ) ) {
				if ( empty( $_GET['error'] ) && ! empty( $_GET['code'] ) ) {
					$token_res = $this->get_api_token( filter_var( $_GET['code'], FILTER_SANITIZE_SPECIAL_CHARS ) );

					$this->save_token( $token_res );
				} elseif ( ! empty( $_GET['error'] ) && ! empty( $_GET['error_description'] ) ) {
					$error_description = sanitize_text_field( $_GET['error_description'] );
				}
			} else {
				$error_description = esc_html__( 'Invalid nonce state', 'pdf-flipbook-heyzine' );
			}
		}

		require_once CL_HEYZINE_PLUGIN_PATH . 'admin/partials/cl-heyzine-admin-invalid-token.php';
	}

	/**
	 * Render the settings page for this plugin.
	 */
	private function render_settings_page_valid_token() {

		$nonce     = wp_create_nonce( $this->nonce_action );
		$oauth_url = $this->base_url . $this->api_auth . '?response_type=code&client_id=' . $this->client_id . '&state=' . $nonce . '&redirect_uri=' . $this->redirect_uri;

		require_once CL_HEYZINE_PLUGIN_PATH . 'admin/partials/cl-heyzine-admin-valid-token.php';
	}

	/**
	 * Render the settings page for this plugin.
	 */
	private function render_settings_page_create_flipbook() {

		$nonce     = wp_create_nonce( $this->nonce_action );
		$oauth_url = $this->base_url . $this->api_auth . '?response_type=code&client_id=' . $this->client_id . '&state=' . $nonce . '&redirect_uri=' . $this->redirect_uri;

		require_once CL_HEYZINE_PLUGIN_PATH . 'admin/partials/cl-heyzine-admin-create-flipbook.php';
	}	

	/**
	 * Render the settings page for this plugin.
	 */
	public function render_settings_page() {
		if (
			isset( $_GET['cl_action'] )
			&& 'cl_heyzine_delete_token' === $_GET['cl_action']
			&& wp_verify_nonce( sanitize_text_field( wp_unslash( $_GET['heyzine_nonce'] ) ), 'cl_heyzine_delete_token' )
		) {
			delete_option( 'cl_heyzine_oauth_token' );
			delete_option( 'cl_heyzine_oauth_refresh_token' );
			delete_option( 'cl_heyzine_oauth_token_expires_at' );
			delete_option( 'cl_heyzine_oauth_email' );
		}

		if (isset ($_GET['hzaction']) && $_GET['hzaction'] == 'new') {
			$this->render_settings_page_create_flipbook();
		} else if ( false === $this->get_db_oauth_token() ) {
			$this->render_settings_page_invalid_token();
		} else {
			$this->render_settings_page_valid_token();
		}
	}
}
